<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Games | Trang Review Game Số Một Việt Nam</title>
    <link rel="icon" href="https://www.dropbox.com/scl/fi/zpfcdupbqkmmw1u5yt90k/game-min.png?dl=1" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div id="header-placeholder"></div>
    <main class="container text-white">
        <div class="row">
            <div class="col-md-3 mb-4 p-1">
                <div class="p-3 border rounded">
                    <form class="d-flex ms-lg-3 mt-lg-1 mb-3" role="search">
                        <input type="text" class="form-control w-auto me-1" id="searchInput" placeholder="Tìm kiếm..." aria-label="Tìm kiếm" autocomplete="off">
                        <button class="btn btn-outline-secondary" id="searchButton" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <p class="mb-0">Danh Sách Forum</p>
                        <a href="/list_game/danhsachgame.html" class="text-white text-decoration-none">Phân Loại</a>
                    </div>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <img src="https://th.bing.com/th/id/R.efdf1496a5ae5bf31bdf318b1ee4a84d?rik=dKc%2bV4sDr1TOhA&pid=ImgRaw&r=0" alt="Trò chuyện 1" class="rounded-circle me-2" style="width: 40px; height: 40px;">
                            Super Spin Digital
                        </li>
                        <li class="list-group-item">
                            <img src="https://th.bing.com/th/id/R.efdf1496a5ae5bf31bdf318b1ee4a84d?rik=dKc%2bV4sDr1TOhA&pid=ImgRaw&r=0" alt="Trò chuyện 1" class="rounded-circle me-2" style="width: 40px; height: 40px;">
                            Super Spin Digital
                        </li>
                        <li class="list-group-item">
                            <img src="https://th.bing.com/th/id/R.efdf1496a5ae5bf31bdf318b1ee4a84d?rik=dKc%2bV4sDr1TOhA&pid=ImgRaw&r=0" alt="Trò chuyện 1" class="rounded-circle me-2" style="width: 40px; height: 40px;">
                            Super Spin Digital
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-6 mb-4 p-1">
                <div class="p-3 border rounded">
                    
                    <div class="d-flex align-items-center mb-3">
                        <img src="https://th.bing.com/th/id/R.efdf1496a5ae5bf31bdf318b1ee4a84d?rik=dKc%2bV4sDr1TOhA&pid=ImgRaw&r=0" 
                             alt="Trò chuyện 1" 
                             class="rounded-circle me-2" 
                             style="width: 40px; height: 40px;">
                        <div class="flex-grow-1">
                            <h4 class="mb-0">Super Spin Digital</h4>
                        </div>
                        <a href="/list_game/danhsachgame.html" class="text-primary text-decoration-none">Báo Cáo</a>
                    </div>
                    <div class="border rounded p-3" style="height:666px; overflow-y: auto;">
                        <div class="chat-container">
                        </div>
                    </div>
                    <form id="message-form" class="mt-3" enctype="multipart/form-data">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Nhập tin nhắn..." aria-label="Nhập tin nhắn..." name="message" required>
                            <button class="btn btn-primary" type="submit" aria-label="Gửi">
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="col-md-3 mb-4 p-1">
                <div class="p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <p class="mb-0">Thông Tin Hội Thoại</p>
                        <a href="/list_game/danhsachgame.html" class="text-white text-decoration-none">Cài Đặt</a>
                    </div>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <strong>Ngày Thành lập:</strong> 20
                        </li>
                        <li class="mb-2">
                            <strong>Số Thành Viên:</strong> 10
                        </li>
                        <li class="mb-2">
                            <strong>Quản lí:</strong> Nguyễn Văn A
                        </li>
                    </ul>
                    <button class="btn btn-danger mt-3 w-100">Rời Khỏi Diễn Đàn</button>
                </div>
            </div>            
        </div>
    </main>
    
    <div id="footer-placeholder"></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
    // Nạp nội dung header và footer
    const loadHTML = (placeholderId, filePath) => {
        const placeholder = document.getElementById(placeholderId);
        fetch(filePath)
            .then(response => response.text())
            .then(data => {
                placeholder.innerHTML = data;
            })
            .catch(error => console.error('Error loading:', error));
    };

    loadHTML('header-placeholder', '/body/header.html');
    loadHTML('footer-placeholder', '/body/footer.html');

    // Gọi fetchMessages với forumId = 1
    fetchMessages(1);

    // Xử lý sự kiện gửi tin nhắn
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault(); // Ngăn chặn việc gửi form và tải lại trang

        const messageInput = e.target.message;
        const message = messageInput.value.trim();  // Loại bỏ khoảng trắng thừa ở đầu và cuối

        if (!message) {
            alert('Vui lòng nhập tin nhắn');
            return;
        }

        const phoneNumber = '0378911629'; 
        const forumId = 1; 
        const time = new Date().toLocaleTimeString();

        const data = {
            phone_number: phoneNumber,
            mess: message,
            time: time
        };

        fetch(`http://127.0.0.1:5000/api/forums/${forumId}/messages`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(() => {
            // Gọi hàm fetchMessages để cập nhật tin nhắn
            fetchMessages(forumId);
            messageInput.value = '';  // Xóa nội dung ô nhập tin nhắn sau khi gửi
        })
        .catch(error => {
            alert('Lỗi: ' + error.message);
        });
    });
});

// Hàm fetchMessages để lấy tin nhắn từ API
function fetchMessages(forumId) {
    const userDataString = localStorage.getItem('user');
    if (!userDataString) {
        console.error('Không tìm thấy dữ liệu người dùng.');
        return;
    }

    const userData = JSON.parse(userDataString);
    const userPhone = userData.phone;
    const botPhoneNumber = '100010000';  // Số điện thoại của bot

    fetch(`http://127.0.0.1:5000/api/forums/1/messages`)
        .then(response => response.json())
        .then(data => {
            console.log(data);  // Kiểm tra dữ liệu tin nhắn
            if (!data.messages) {
                throw new Error('Không có tin nhắn nào.');
            }
            const chatContainer = document.querySelector('.chat-container');

            // Lưu vị trí hiện tại của cuộn
            const scrollPosition = chatContainer.scrollTop;

            // Xóa các tin nhắn hiện tại
            chatContainer.innerHTML = '';

            data.messages.forEach(message => {
                let userType = message.phone_number === botPhoneNumber ? 'bot' :
                               message.phone_number === userPhone ? 'me' : 'otherUser';

                console.log(`Adding message: ${message.mess} (userType: ${userType})`);  // Kiểm tra loại tin nhắn
                addMessage(userType, message.mess, message.time);
            });

            // Nếu người dùng đã cuộn đến đáy trước khi tải tin nhắn mới, giữ cuộn ở đáy
            if (scrollPosition + chatContainer.clientHeight >= chatContainer.scrollHeight) {
                chatContainer.scrollTop = chatContainer.scrollHeight;  // Cuộn xuống tin nhắn mới nhất
            }
        })
        .catch(error => {
            console.error('Error fetching messages:', error);
        });
}

// Hàm addMessage để thêm tin nhắn vào giao diện
function addMessage(userType, messageContent, time) {
    const chatContainer = document.querySelector('.chat-container');  // Đảm bảo bạn có một container cho tất cả các tin nhắn

    const messageTypes = {
        bot: `
            <div class="mb-3 message-user-not-me">
                <div class="d-flex align-items-start">
                    <img src="https://via.placeholder.com/30" class="rounded-circle me-2" style="width: 30px; height: 30px;" alt="BOT">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <p class="mb-0">BOT TIN TỨC</p>
                        </div>
                        <div class="p-3 border rounded text-white">
                            <p class="mb-0">${messageContent}</p>
                            <small class="text-muted">${time}</small>
                        </div>
                    </div>
                </div>
            </div>
        `,
        otherUser: `
            <div class="mb-3 message-user-not-me">
                <div class="d-flex align-items-start">
                    <img src="https://via.placeholder.com/30" class="rounded-circle me-2" style="width: 30px; height: 30px;" alt="Other User">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <p class="mb-0">OTHER USER</p>
                        </div>
                        <div class="p-3 border rounded text-white">
                            <p class="mb-0">${messageContent}</p>
                            <small class="message-time">${time}</small>
                        </div>
                    </div>
                </div>
            </div>
        `,
        me: `
            <div class="mb-3 message-user-me">
                <div class="d-flex flex-column align-items-end">
                    <div class="p-2 border rounded text-white message">
                        <p class="mb-0">${messageContent}</p>
                        <small class="message-time">${time}</small>
                    </div>
                </div>
            </div>
        `
    };

    chatContainer.innerHTML += messageTypes[userType] || messageTypes.me;  // Thêm tin nhắn vào container
    chatContainer.scrollTop = chatContainer.scrollHeight;  // Luôn cuộn xuống tin nhắn mới nhất
}

    </script>

</body>
</html>